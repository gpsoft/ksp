# 電子証明書、鍵ペア、公開鍵、PKI???

## 背景

マイナンバーカード持ってますか? マイナンバーカードには、**電子証明書**や**秘密鍵**を組み込むことができます。秘密鍵は、**電子署名する**ときに使います。電子証明書は、署名を**検証する**ときに使います。署名したり検証するときは、**公開鍵暗号**と呼ばれる方式を使います。**PKI**は、公開鍵暗号を運用するためのインフラです。

チンプンカンプンですか? この記事を読めば、卒業できるかもしれません。

## 暗号の使いみち(その1)

「暗号」と聞くと、何かを隠すのに使うと考えるのが一般的でしょう。例えば、秘密のパスワードを知ってる人だけが解読できるように暗号化してメッセージを送るとかです。このときの

- 秘密のパスワードを**鍵**
- 暗号化されたメッセージを**暗文**
- 暗号化前のメッセージを**平文**
- 暗文を解読して平文へ戻すことを**復号する**

と呼びます。

## 共通鍵暗号

ここで、「あなた(YOU)」と「わたし(ME)」と「悪者」に登場してもらいましょう。

YOUとMEは、悪者に内緒でメッセージを交換したいです。そのために、あらかじめ、YOUとMEだけが知っている鍵を用意しておきます。この鍵が悪者にバレない限り、安全にメッセージを交換できます。たとえ暗文が悪者に見られたとしても、悪者は鍵なしには復号できません。このような暗号方式を**共通鍵暗号**と呼びます(YOUとMEが共通の鍵を共有するので)。共通鍵暗号のアルゴリズムには、DESやAESなどがあります。

共通鍵暗号の難点は、「あらかじめ、YOUとMEだけが知っている鍵を用意」する必要があるところです。不特定のYOU(例えば通販業者とか)と秘密のやりとりをするのには向きませんね。共通鍵をメールで送ったりするのは安全とは言えませんから。

この難点を解決するのが、**公開鍵暗号**と呼ばれる暗号方式です。

## 公開鍵暗号

公開鍵暗号では、2つの鍵を使います。**公開鍵**と**秘密鍵**です。2つ合わせて**鍵ペア**と呼びます。そしてYOUとMEは、それぞれ、自分自身の専用の鍵ペアを持ちます。なので、この場合、鍵は合計4つ存在することになります。

- 公開YOU鍵
- 秘密YOU鍵
- 公開ME鍵
- 秘密ME鍵

の4つです。

公開鍵は、文字通り公開します。悪者に知られても構いません。一方、秘密鍵は、文字通り秘密です。秘密YOU鍵はYOUだけが知っていますし、秘密ME鍵はME以外の人に見せてはなりません。

公開鍵暗号の面白いところは、

> 公開鍵で暗号化された暗文は、秘密鍵でのみ復号できる

という点です。このフレーズは大事なので、もう一度読んでみてください。なんでそうなるのかは、難しい数学の世界の話なので無視しておきましょう。

例えばYOUがMEに内緒のメッセージを送りたい場合は、公開ME鍵で暗号化すればOKです。その暗文は、秘密ME鍵を知っているMEにしか復号できません。誰でもMEに秘密のメッセージを送れるけど、読めるのはMEだけです。逆に、MEがYOUへ返事を返すときは公開YOU鍵で暗号化して送ります。

繰り返しますが、暗号化に使う鍵は完全に公開できて、復号に使う鍵だけを秘密にします。最も大事な鍵は、他人と共有する必要がない、というのが公開鍵暗号のミソです。公開鍵暗号のアルゴリズムとしては、RSAが有名です。

## 暗号の使いみち(その2)

実は、暗号の使いみちは、もう一つあります。それは、信憑性をチェックすることです。例えば、YOUが何かの会合への出欠通知をハガキで送るとしましょう。文面を誰に見られようと構わないけど、改ざん(「出席」を「欠席」に変えたり、氏名を別人に変えたり)されるのは困ります。封書で送ればいいじゃないか、と思うかもしれませんが、面倒だしコストも増えます。それに、悪者がYOUに成りすまして勝手に出欠通知を郵送してしまう可能性もありますよね。

そこで改ざんを困難にするために、消せないボールペンで手書きしたり、署名捺印するでしょう。受け取ったMEは、修正された形跡を探ったり、必要なら筆跡鑑定に出したり印影を照合して、改ざんされてないことをチェックできます。このときの

- 「ボールペンで手書きしたり署名捺印する行為」をまとめて、**署名する**
- 「修正の形跡チェックや筆跡鑑定、印影照合する行為」をまとめて、**署名検証する**

と呼ぶことにしましょう。

そして公開鍵暗号は、署名したり署名検証するのにも使えます。例えばYOUからMEへメッセージを送るとしましょう。受け取ったMEは、それが本当にYOUからのメッセージで、メッセージの内容が悪者に書き換えられてないかチェックしたいです。そのためYOUは、メッセージを秘密YOU鍵で暗号化したものを、平文のメッセージに添えて送ります。この、「メッセージを秘密YOU鍵で暗号化したもの」のことを**電子署名**と呼びます(※1)。この電子署名を平文メッセージに添える行為が、前述の出欠通知における「署名する」に相当します。

秘密YOU鍵を知っているのはYOUだけなので、YOU以外の人が電子署名を偽造することは不可能です。そして面白いことに、

> この電子署名(秘密鍵で暗号化された暗文)は、公開YOU鍵を使って誰でも復号できる

のです。このフレーズも大事なので、もう一度読んで噛みしめてください(なんでそうなるのかは数学の専門家にお任せ)。

よって、受け取ったMEは、平文のメッセージと、電子署名を復号したものとを比較する(※2)ことにより、改ざんを見破ることができる、というわけです。この比較する行為が、前述の「署名検証する」に相当します。

## PKI、認証局、電子証明書

公開鍵暗号のおかげで、内緒のメッセージをやりとりでき、改ざんも見破れるようになりました。最後に残るのが、「どうやって公開鍵を公開するか」という問題です。

公開YOU鍵は誰に見られても構わないので、メールで送ってもいいし、Webサイトにアップしても良いでしょう。しかし、その公開YOU鍵自体が改ざんされたら困りますよね。幸い、我々はデータの信憑性をチェックする手段を持っています。そう、電子署名の出番です。つまり、公開YOU鍵に電子署名を付けて公開すればいいのです。

でも、誰に署名してもらいましょうか。YOUが署名するのでは意味がありません(その署名を検証するには公開YOU鍵が必要なので)。別の誰かに頼む必要があります。仮にCAさんと呼びましょう。CAさんに、公開YOU鍵へ電子署名してもらい、その電子署名を添えて公開するのです。これなら、「公開CAさん鍵」を使って誰でも署名検証できます。

しかし、もし「公開CAさん鍵」の信憑性が疑わしいとなったらどうしましょう。さらに別の誰か(CA2さん)に「公開CAさん鍵」へ署名してもらう必要があります。そして今度は「公開CA2さん鍵」の信憑性が問題になって……この疑惑の連鎖は、いつまでたっても終わりません。

そこで登場するのが、**PKI(公開鍵基盤)** と呼ばれるインフラです。PKIのもとでは、**認証局**と呼ばれる機関が公開YOU鍵に電子署名してくれます。認証局の公開鍵には、さらに上位の認証局が電子署名します。そして疑惑の連鎖をストップするのが、**ルート認証局**と呼ばれる、最上級の認証局です。ルート認証局の公開鍵にはルート認証局自身が電子署名します。

ルート認証局の公開鍵は信じられるのでしょうか? ルート認証局の数は限られており、その公開鍵は広く公開され、コンピュータやスマホのOSやアプリなどに組み込まれて配布されるので、改ざんが困難だし改ざんされても見破りやすい、という理屈みたいです。

結局、公開YOU鍵の信憑性チェックのためには、

- 公開YOU鍵
- 公開YOU鍵に対する、最初の認証局による電子署名
- 最初の認証局の公開鍵
- 最初の認証局の公開鍵に対する、上位の認証局による電子署名
- 上位の認証局の公開鍵
- 上位の認証局の公開鍵に対する、更に上位の……
- ……
- ルート認証局の公開鍵
- ルート認証局の公開鍵に対する、ルート認証局による電子署名

が必要です(連鎖の段数は不定)。これらを全てまとめたものを、YOUの**電子証明書**と呼びます。公開鍵を公開するときは、電子証明書の形にして配布することになります。

マイナンバーカードには、この電子証明書と秘密鍵が組み込まれます。そのおかげで、コンビニで住民票の写しを発行するときは、電子証明書により本人確認できます。また、e-Taxで確定申告するときは、秘密鍵を使って電子署名することができます(そして税務署は、電子証明書を使って申告書の信憑性をチェックできる)。

## 【余談】※1と※2の補足 〜 ハッシュ値について

※1に関して、現実的には、「『メッセージのハッシュ値』を秘密YOU鍵で暗号化したもの」を電子署名として使うことが多いです。また※2に関しても、比較するのは、「平文のメッセージのハッシュ値」と「電子署名を復号したもの」です。

**ハッシュ**は、データを「要約」する処理です。要約後のデータのことを**ハッシュ値**と呼びます。ハッシュ値を元データに戻すことはできないので、zipや7zのような「圧縮」とは違います。ハッシュには、以下のような特徴があります。

- ハッシュ値のデータサイズは、比較的、小さい
- ハッシュ値のデータサイズは、元データのサイズに関係なく固定長になる
- 2つの異なる元データがあるとき、それぞれのハッシュ値が同じになる(コリジョン)ことは滅多に無い
- ハッシュ値の計算は、暗号化に比べると軽い
- ハッシュ値から元データを復元することは困難
- たとえ、元データとハッシュ値を知っていても、同じハッシュ値になるような(つまりコリジョンを起こすような)、別の元データを見つけるのは困難

こういった性質から、電子署名にハッシュ値を使うのは理にかなっています。ハッシュのアルゴリズムには、md5, sha1, sha256などがあります。
