# DI, 依存性注入

ディペンデンシー・インジェクション。Dependency Injection. DI. 想像力を働かせてもなかなか意味を類推しにくい用語の一つです。日本語では「依存性注入」と訳されることが多く、なおさら分かりにくくなっている気がします。

## 依存性

「依存性」というのは「(誰かが)依存している何か」を指します。「のび太はドラえもんに依存している」と言うとき、ドラえもんは、「のび太の依存性」になっています。

```
// のび太はドラえもんに依存している。
class Nobita {
  Doraemon doraemon;

  void doHomework() {
    doraemon.pleaseHelp();
    ...
  }
}
```

「依存性」は、その人にとって「欠かせないもの」です。ドラえもん無しには、のび太は宿題を終わらせることができません。

## 依存性の注入

問題は、のび太がどうやって`Doraemon`オブジェクトを手に入れるかです。方法は3つしかありません。

- 自分で`new`する
- どこかから取ってくる
- 誰かからもらう

順番に例を見てみましょう。ちなみに、3番目の方法が依存性注入です(誰かに注入してもらう)。

### 自分でnewする

```
class Nobita {
  Doraemon doraemon;

  Nobita() {
    doraemon = new Doraemon(); // 自力でnew
  }

  void doHomework() {
    doraemon.pleaseHelp();
    ...
  }
}
```

### どこかから取ってくる

```
class Nobita {
  Doraemon doraemon;

  Nobita() {
    doraemon = Doraemon::getInstance(); // メソッドを呼んで取得
  }

  void doHomework() {
    doraemon.pleaseHelp();
    ...
  }
}
```

### 誰かからもらう(依存性注入)

```
class Nobita {
  Doraemon doraemon;

  Nobita(Doraemon dora) { // 引数経由で、もらう
    doraemon = dora;
  }

  void doHomework() {
    doraemon.pleaseHelp();
    ...
  }
}
```

この例では、コンストラクタの引数を通してDoraemonオブジェクトを注入してもらっていますが、いつもそうとは限りません(他の手段で注入してもらうケースもある)。大事なのは、「他所から」注入してもらう、という点です。

## DIコンテナ

というわけで、DIというのは、クラスが依存性(依存先オブジェクト)を手に入れるための、設計スタイルの一手法です。ここで登場人物を整理しておきましょう。

- クライアント ...依存元(のび太)
- サービス ...依存先(ドラえもん)
- DIコンテナ

まず、のび太の立場、つまり依存元がクライアントです。次に、クライアントが利用する依存先(つまりドラえもん)がサービスです。最後に、クライアントへサービスを注入する誰かのことをDIコンテナと呼びます。

他の2つのスタイル(「自分で`new`」と「どこかから取得」)に比べると、DIの特徴は以下の通りです。

- クライアントは、サービスの出自に一切関わりません
- クライアントは、(暗に)DIコンテナに依存します

クライアントは、DIコンテナの中でしか生きられない。「コンテナ」のニュアンスは、そういうことでしょう。

## DIの利点

### 依存性の集中管理

大きなシステムでは、クラス間の依存関係も複雑になりがちです。1つのサービスを生成するだけでも、複雑な手順が必要かもしれません。そういった面倒を、DIコンテナが一手に引き受けてくれれば、クライアントの実装がスッキリすると期待できます。

そして外部ライブラリを使えば、そんなDIコンテナ機能が簡単に手に入ります(Webフレームワークと呼ばれるライブラリの多くは、DIコンテナ機能を持っています)。

### 依存性のカスタマイズ

のび太の依存性は、実はドラえもんでなくても、ネコ型ロボットなら何でも良いのかもしれません。

```
// のび太はネコ型ロボットに依存している。
class Nobita {
  CatRobot robot;

  void doHomework() {
    robot.pleaseHelp();
    ...
  }
}
```

この場合、DIコンテナが、`Doraemon`オブジェクトを注入しようと、`Dorami`オブジェクトを注入しようと、のび太は気にしません(どちらも`CatRobot`の一種なので)。あえて冷たいロボットを注入して、のび太をテストすることもできますね。

